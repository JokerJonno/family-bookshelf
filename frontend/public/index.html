<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Family Shelf</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Josefin+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0b0e;--surface:#141018;--surface2:#1c1822;--border:#2a2235;
  --accent:#c0392b;--accent2:#8b1a1a;--accent-glow:rgba(192,57,43,0.15);
  --gold:#c9a84c;--gold-dim:#7a6130;
  --text:#e8e0d5;--text-dim:#8a7f8a;--text-muted:#4a4050;
  --star-on:#c9a84c;--star-off:#2a2235;
  --radius:4px;--shadow:0 8px 32px rgba(0,0,0,0.6);
  --reading:#2ecc71;--tbr:#3498db;--finished:#c9a84c;
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:18px;line-height:1.6;min-height:100vh;
  background-image:radial-gradient(ellipse 60% 40% at 50% 0%,rgba(140,20,20,0.08) 0%,transparent 70%);}

/* ‚îÄ‚îÄ Reader Profile Bar ‚îÄ‚îÄ */
#profileBar{display:flex;align-items:center;gap:0.75rem;padding:0.6rem 2rem;background:var(--surface2);border-bottom:1px solid var(--border);flex-wrap:wrap;}
.profile-label{font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-muted);}
.profile-chips{display:flex;gap:0.4rem;flex-wrap:wrap;flex:1;}
.profile-chip{font-family:'Josefin Sans',sans-serif;font-size:0.63rem;letter-spacing:0.1em;text-transform:uppercase;
  padding:0.3rem 0.9rem;border-radius:20px;border:1px solid var(--border);color:var(--text-dim);cursor:pointer;transition:all 0.15s;background:var(--surface);}
.profile-chip:hover{border-color:var(--gold);color:var(--gold);}
.profile-chip.active{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,0.1);}
.add-reader-btn{font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;
  background:none;border:1px dashed var(--border);color:var(--text-muted);padding:0.3rem 0.75rem;border-radius:20px;cursor:pointer;transition:all 0.15s;}
.add-reader-btn:hover{border-color:var(--gold);color:var(--gold);}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header{text-align:center;padding:2.5rem 2rem 1.5rem;position:relative;border-bottom:1px solid var(--border);}
header::before{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:200px;height:1px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);}
.site-title{font-family:'Playfair Display',serif;font-size:clamp(2rem,5vw,3.5rem);font-weight:700;letter-spacing:0.02em;color:var(--text);line-height:1.1;}
.site-title span{color:var(--accent);}
.site-subtitle{font-family:'Josefin Sans',sans-serif;font-size:0.65rem;letter-spacing:0.3em;text-transform:uppercase;color:var(--text-dim);margin-top:0.4rem;}

/* ‚îÄ‚îÄ Nav Tabs ‚îÄ‚îÄ */
.nav-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);background:var(--surface);overflow-x:auto;}
.nav-tab{font-family:'Josefin Sans',sans-serif;font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;
  padding:0.85rem 1.5rem;background:none;border:none;color:var(--text-muted);cursor:pointer;
  border-bottom:2px solid transparent;margin-bottom:-1px;white-space:nowrap;transition:all 0.15s;}
.nav-tab:hover{color:var(--text-dim);}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
.toolbar{display:flex;flex-wrap:wrap;gap:0.6rem;align-items:center;padding:1rem 2rem;background:var(--surface);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);}
.search-wrap{flex:1;min-width:180px;position:relative;}
.search-wrap input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);
  padding:0.5rem 1rem 0.5rem 2.3rem;font-family:'Crimson Pro',serif;font-size:1rem;border-radius:var(--radius);outline:none;transition:border-color 0.2s;}
.search-wrap input:focus{border-color:var(--accent);}
.search-wrap::before{content:'‚åï';position:absolute;left:0.7rem;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:1.2rem;pointer-events:none;}
select{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:0.5rem 2rem 0.5rem 0.85rem;
  font-family:'Josefin Sans',sans-serif;font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;border-radius:var(--radius);
  outline:none;cursor:pointer;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238a7f8a'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 0.7rem center;transition:border-color 0.2s;}
select:focus{border-color:var(--accent);}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn{font-family:'Josefin Sans',sans-serif;font-size:0.68rem;letter-spacing:0.15em;text-transform:uppercase;
  padding:0.55rem 1.3rem;border:none;border-radius:var(--radius);cursor:pointer;transition:all 0.2s;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#a93226;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--border);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-sm{padding:0.35rem 0.85rem;font-size:0.6rem;}
.btn-gold{background:var(--gold);color:#1a1000;}
.btn-gold:hover{background:#d4a847;}

/* ‚îÄ‚îÄ Status Tabs ‚îÄ‚îÄ */
.status-tabs{display:flex;gap:0.5rem;flex-wrap:wrap;}
.status-tab{font-family:'Josefin Sans',sans-serif;font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;
  padding:0.35rem 0.9rem;border-radius:20px;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;transition:all 0.15s;background:none;}
.status-tab:hover{border-color:var(--text-dim);color:var(--text-dim);}
.status-tab.active[data-status="all"]{border-color:var(--accent);color:var(--accent);}
.status-tab.active[data-status="finished"]{border-color:var(--finished);color:var(--finished);}
.status-tab.active[data-status="reading"]{border-color:var(--reading);color:var(--reading);}
.status-tab.active[data-status="tbr"]{border-color:var(--tbr);color:var(--tbr);}

/* ‚îÄ‚îÄ Filter Tags ‚îÄ‚îÄ */
.filter-tags{display:flex;flex-wrap:wrap;gap:0.4rem;padding:0.6rem 2rem;border-bottom:1px solid var(--border);background:var(--bg);min-height:40px;}
.tag{font-family:'Josefin Sans',sans-serif;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;
  padding:0.25rem 0.75rem;border-radius:20px;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;transition:all 0.15s;background:var(--surface);}
.tag:hover{border-color:var(--accent);color:var(--accent);}
.tag.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow);}
.tag.trigger{border-color:var(--gold-dim);color:var(--gold-dim);}
.tag.trigger.active{background:rgba(201,168,76,0.1);color:var(--gold);border-color:var(--gold);}
.tag.series-tag{border-color:#553399;color:#9966dd;}
.tag.series-tag.active{background:rgba(153,102,221,0.1);}

/* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */
.stats-bar{display:flex;gap:1.5rem;padding:0.5rem 2rem;font-family:'Josefin Sans',sans-serif;font-size:0.6rem;
  letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border);background:var(--bg);flex-wrap:wrap;}
.stat-val{color:var(--text-dim);}

/* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:1.25rem;padding:1.5rem 2rem;max-width:1800px;margin:0 auto;}
.book-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
  cursor:pointer;transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s;position:relative;}
.book-card:hover{transform:translateY(-4px);box-shadow:var(--shadow);border-color:var(--accent);}
.book-cover{width:100%;aspect-ratio:2/3;object-fit:cover;display:block;background:var(--surface2);}
.book-cover-placeholder{width:100%;aspect-ratio:2/3;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--surface2),var(--border));font-size:3rem;color:var(--text-muted);}
.status-badge{position:absolute;top:0.5rem;left:0.5rem;font-family:'Josefin Sans',sans-serif;font-size:0.55rem;
  letter-spacing:0.1em;text-transform:uppercase;padding:0.2rem 0.5rem;border-radius:10px;}
.status-badge.reading{background:rgba(46,204,113,0.2);color:var(--reading);border:1px solid var(--reading);}
.status-badge.tbr{background:rgba(52,152,219,0.15);color:var(--tbr);border:1px solid var(--tbr);}
.card-body{padding:0.75rem;}
.card-title{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:700;color:var(--text);line-height:1.3;margin-bottom:0.15rem;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.card-series{font-family:'Josefin Sans',sans-serif;font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;color:#9966dd;margin-bottom:0.15rem;}
.card-author{font-family:'Josefin Sans',sans-serif;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.4rem;}
.card-rating{display:flex;align-items:center;gap:0.35rem;}
.stars-display{display:flex;gap:1px;}
.stars-display .s{font-size:0.8rem;color:var(--star-off);}
.stars-display .s.on{color:var(--star-on);}
.rating-count{font-family:'Josefin Sans',sans-serif;font-size:0.58rem;color:var(--text-muted);}
.card-genres{display:flex;flex-wrap:wrap;gap:0.2rem;margin-top:0.4rem;}
.genre-chip{font-family:'Josefin Sans',sans-serif;font-size:0.52rem;letter-spacing:0.06em;text-transform:uppercase;
  padding:0.12rem 0.45rem;border-radius:20px;border:1px solid var(--border);color:var(--text-muted);}
.genre-chip.highlight{border-color:var(--accent2);color:var(--accent);}
.card-actions{display:flex;gap:0.4rem;padding:0 0.75rem 0.75rem;}
.action-btn{flex:1;font-family:'Josefin Sans',sans-serif;font-size:0.55rem;letter-spacing:0.08em;text-transform:uppercase;
  padding:0.35rem;background:var(--surface2);border:1px solid var(--border);color:var(--text-muted);border-radius:var(--radius);cursor:pointer;transition:all 0.15s;}
.action-btn:hover{border-color:var(--accent);color:var(--accent);}

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(4px);z-index:1000;
  display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:2rem 1rem;opacity:0;pointer-events:none;transition:opacity 0.25s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:8px;width:100%;max-width:820px;
  box-shadow:0 24px 80px rgba(0,0,0,0.8);position:relative;transform:translateY(20px);transition:transform 0.25s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;line-height:1;transition:color 0.15s;z-index:2;}
.modal-close:hover{color:var(--accent);}

/* ‚îÄ‚îÄ Book Detail ‚îÄ‚îÄ */
.book-detail{display:grid;grid-template-columns:200px 1fr;}
@media(max-width:600px){.book-detail{grid-template-columns:1fr;}}
.book-detail-cover img,.book-detail-cover .cover-ph{width:100%;height:100%;min-height:280px;object-fit:cover;border-radius:8px 0 0 8px;display:block;}
.book-detail-cover .cover-ph{display:flex;align-items:center;justify-content:center;font-size:4rem;background:var(--surface2);border-radius:8px 0 0 8px;}
.book-detail-info{padding:1.75rem;overflow-y:auto;max-height:85vh;}
.detail-title{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:700;line-height:1.2;margin-bottom:0.2rem;}
.detail-series{font-family:'Josefin Sans',sans-serif;font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:#9966dd;margin-bottom:0.2rem;}
.detail-author{font-family:'Josefin Sans',sans-serif;font-size:0.68rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.85rem;}
.detail-meta{display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.85rem;}
.meta-pill{font-family:'Josefin Sans',sans-serif;font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;
  padding:0.22rem 0.65rem;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);}
.meta-pill.tw{border-color:var(--gold-dim);color:var(--gold);background:rgba(201,168,76,0.05);}
.meta-pill.status-reading{border-color:var(--reading);color:var(--reading);}
.meta-pill.status-tbr{border-color:var(--tbr);color:var(--tbr);}
.avg-rating-display{display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;padding:0.65rem;
  background:var(--surface2);border-radius:var(--radius);border:1px solid var(--border);}
.avg-stars-big{display:flex;gap:3px;}
.avg-stars-big .s{font-size:1.2rem;}
.avg-num{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--gold);}
.avg-label{font-family:'Josefin Sans',sans-serif;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);}
.kindle-link{display:inline-flex;align-items:center;gap:0.5rem;font-family:'Josefin Sans',sans-serif;font-size:0.65rem;
  letter-spacing:0.12em;text-transform:uppercase;color:var(--gold);text-decoration:none;border:1px solid var(--gold-dim);
  padding:0.35rem 0.85rem;border-radius:var(--radius);margin-bottom:0.85rem;transition:all 0.15s;}
.kindle-link:hover{background:rgba(201,168,76,0.1);}
.synopsis{font-size:0.95rem;color:var(--text-dim);line-height:1.7;margin-bottom:1.25rem;font-style:italic;}
.section-label{font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;
  color:var(--text-muted);margin-bottom:0.65rem;display:flex;align-items:center;gap:0.75rem;}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.rating-list{display:flex;flex-direction:column;gap:0.65rem;margin-bottom:1.25rem;}
.rating-item{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:0.75rem 0.9rem;}
.rating-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.35rem;}
.reader-name{font-family:'Josefin Sans',sans-serif;font-size:0.68rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text);}
.rating-date{font-family:'Josefin Sans',sans-serif;font-size:0.58rem;color:var(--text-muted);}
.rating-blurb{font-size:0.92rem;color:var(--text-dim);font-style:italic;}
.delete-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.75rem;padding:0.15rem;transition:color 0.15s;margin-left:0.4rem;}
.delete-btn:hover{color:var(--accent);}

/* ‚îÄ‚îÄ Add Rating Form ‚îÄ‚îÄ */
.add-rating-form{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:0.9rem;}
.star-picker{display:flex;gap:4px;margin-bottom:0.65rem;}
.star-picker .sp{font-size:1.5rem;cursor:pointer;color:var(--star-off);transition:color 0.1s,transform 0.1s;line-height:1;}
.star-picker .sp:hover,.star-picker .sp.active{color:var(--star-on);transform:scale(1.15);}

/* ‚îÄ‚îÄ Add Book Form ‚îÄ‚îÄ */
.add-book-form{padding:1.75rem;}
.add-book-form h2{font-family:'Playfair Display',serif;font-size:1.4rem;margin-bottom:1.25rem;color:var(--text);}
.form-group{margin-bottom:0.85rem;}
.form-group label{display:block;font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.15em;
  text-transform:uppercase;color:var(--text-muted);margin-bottom:0.3rem;}
.form-row{display:flex;gap:0.6rem;flex-wrap:wrap;margin-bottom:0.65rem;}
.form-row input{flex:1;}
input[type=text],input[type=number],textarea{background:var(--bg);border:1px solid var(--border);color:var(--text);
  padding:0.5rem 0.8rem;font-family:'Crimson Pro',serif;font-size:1rem;border-radius:var(--radius);outline:none;width:100%;transition:border-color 0.2s;}
input[type=text]:focus,input[type=number]:focus,textarea:focus{border-color:var(--accent);}
textarea{resize:vertical;min-height:65px;}
.lookup-row{display:flex;gap:0.5rem;}
.lookup-row input{flex:1;}
.lookup-preview{display:none;gap:1.25rem;padding:0.9rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);margin:0.85rem 0;align-items:flex-start;}
.lookup-preview.visible{display:flex;}
.lookup-preview img{width:70px;border-radius:2px;flex-shrink:0;}
.lookup-title{font-family:'Playfair Display',serif;font-size:1.05rem;margin-bottom:0.15rem;}
.lookup-author{font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.4rem;}
.tag-editor{display:flex;flex-wrap:wrap;gap:0.3rem;padding:0.45rem;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);min-height:40px;cursor:text;}
.tag-editor .te-tag{display:flex;align-items:center;gap:0.25rem;font-family:'Josefin Sans',sans-serif;font-size:0.6rem;
  letter-spacing:0.08em;text-transform:uppercase;padding:0.18rem 0.55rem;border-radius:20px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);}
.te-remove{cursor:pointer;color:var(--text-muted);font-size:0.75rem;line-height:1;transition:color 0.15s;}
.te-remove:hover{color:var(--accent);}
.te-input{background:none;border:none;outline:none;color:var(--text);font-family:'Crimson Pro',serif;font-size:0.9rem;min-width:80px;flex:1;padding:0.1rem 0;}
.status-select-row{display:flex;gap:0.5rem;flex-wrap:wrap;}
.status-opt{font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;
  padding:0.35rem 1rem;border-radius:20px;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;transition:all 0.15s;background:none;}
.status-opt:hover{border-color:var(--text-dim);color:var(--text-dim);}
.status-opt.active[data-s="finished"]{border-color:var(--finished);color:var(--finished);}
.status-opt.active[data-s="reading"]{border-color:var(--reading);color:var(--reading);}
.status-opt.active[data-s="tbr"]{border-color:var(--tbr);color:var(--tbr);}

/* ‚îÄ‚îÄ Stats Page ‚îÄ‚îÄ */
.stats-page{padding:2rem;max-width:1200px;margin:0 auto;}
.stats-page h2{font-family:'Playfair Display',serif;font-size:1.8rem;margin-bottom:1.5rem;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:2rem;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;}
.stat-card-num{font-family:'Playfair Display',serif;font-size:2.5rem;color:var(--gold);line-height:1;}
.stat-card-label{font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted);margin-top:0.25rem;}
.stats-section{margin-bottom:2rem;}
.stats-section h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:1rem;color:var(--text-dim);}
.reader-row{display:flex;align-items:center;gap:1rem;padding:0.75rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:0.5rem;}
.reader-avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;
  font-family:'Josefin Sans',sans-serif;font-size:0.8rem;color:#fff;font-weight:bold;flex-shrink:0;}
.reader-info{flex:1;}
.reader-info-name{font-family:'Josefin Sans',sans-serif;font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text);}
.reader-info-sub{font-family:'Josefin Sans',sans-serif;font-size:0.6rem;color:var(--text-muted);}
.genre-bar-row{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem;}
.genre-bar-label{font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);width:140px;text-align:right;flex-shrink:0;}
.genre-bar-track{flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;}
.genre-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:4px;transition:width 0.8s ease;}
.genre-bar-count{font-family:'Josefin Sans',sans-serif;font-size:0.6rem;color:var(--text-muted);width:24px;}
.top-book-row{display:flex;align-items:center;gap:0.75rem;padding:0.65rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:0.5rem;}
.top-book-cover{width:40px;height:60px;object-fit:cover;border-radius:2px;background:var(--surface2);flex-shrink:0;}
.top-book-info{flex:1;}
.top-book-title{font-family:'Playfair Display',serif;font-size:0.95rem;}
.top-book-author{font-family:'Josefin Sans',sans-serif;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);}

/* ‚îÄ‚îÄ Activity Feed ‚îÄ‚îÄ */
.activity-page{padding:2rem;max-width:700px;margin:0 auto;}
.activity-page h2{font-family:'Playfair Display',serif;font-size:1.8rem;margin-bottom:1.5rem;}
.activity-item{display:flex;gap:1rem;padding:0.85rem 0;border-bottom:1px solid var(--border);}
.activity-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.9rem;flex-shrink:0;margin-top:0.1rem;}
.activity-icon.book_added{background:rgba(192,57,43,0.2);}
.activity-icon.rating_added{background:rgba(201,168,76,0.15);}
.activity-icon.book_removed{background:rgba(100,100,100,0.15);}
.activity-body{flex:1;}
.activity-text{font-size:0.95rem;color:var(--text-dim);line-height:1.4;}
.activity-text strong{color:var(--text);}
.activity-time{font-family:'Josefin Sans',sans-serif;font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-top:0.2rem;}

/* ‚îÄ‚îÄ Scanner ‚îÄ‚îÄ */
.scanner-area{padding:1.75rem;}
.scanner-area h2{font-family:'Playfair Display',serif;font-size:1.4rem;margin-bottom:1rem;}
#scannerVideo{width:100%;border-radius:var(--radius);background:#000;display:block;}
.scan-result{margin-top:1rem;padding:0.75rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);
  font-family:'Josefin Sans',sans-serif;font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;}

/* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-left:0.4rem;}
@keyframes spin{to{transform:rotate(360deg);}}
.empty-state{text-align:center;padding:5rem 2rem;color:var(--text-muted);grid-column:1/-1;}
.empty-state .icon{font-size:3.5rem;margin-bottom:0.75rem;opacity:0.4;}
.empty-state p{font-family:'Josefin Sans',sans-serif;font-size:0.68rem;letter-spacing:0.18em;text-transform:uppercase;}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:var(--surface2);
  border:1px solid var(--border);color:var(--text);padding:0.65rem 1.4rem;border-radius:40px;
  font-family:'Josefin Sans',sans-serif;font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;z-index:9999;transition:transform 0.3s;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.success{border-color:var(--accent);}
.toast.error{border-color:#c0392b;color:#e74c3c;}
.page{display:none;}.page.active{display:block;}

@media(max-width:700px){
  .grid{grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:0.85rem;padding:1rem;}
  .toolbar{padding:0.75rem 1rem;}
  .stats-page,.activity-page{padding:1rem;}
  #profileBar{padding:0.5rem 1rem;}
  .book-detail{grid-template-columns:1fr;}
  .book-detail-cover img,.book-detail-cover .cover-ph{min-height:180px;max-height:260px;border-radius:8px 8px 0 0;}
  .filter-tags{padding:0.5rem 1rem;}
}
</style>
</head>
<body>

<!-- Reader Profile Bar -->
<div id="profileBar">
  <span class="profile-label">Reading as:</span>
  <div class="profile-chips" id="profileChips"></div>
  <button class="add-reader-btn" onclick="addReader()">+ Add reader</button>
</div>

<header>
  <div class="site-title">The Family <span>Shelf</span></div>
  <div class="site-subtitle">Our shared library &amp; reading log</div>
</header>

<!-- Nav -->
<div class="nav-tabs">
  <button class="nav-tab active" data-page="library" onclick="switchPage('library')">üìö Library</button>
  <button class="nav-tab" data-page="stats" onclick="switchPage('stats')">üìä Stats</button>
  <button class="nav-tab" data-page="activity" onclick="switchPage('activity')">üïê Activity</button>
</div>

<!-- ‚îÄ‚îÄ LIBRARY PAGE ‚îÄ‚îÄ -->
<div id="page-library" class="page active">
  <div class="toolbar">
    <div class="search-wrap"><input type="text" id="searchInput" placeholder="Search titles, authors, series‚Ä¶"></div>
    <div class="status-tabs">
      <button class="status-tab active" data-status="all" onclick="setStatus('all')">All</button>
      <button class="status-tab" data-status="finished" onclick="setStatus('finished')">‚úì Finished</button>
      <button class="status-tab" data-status="reading" onclick="setStatus('reading')">üìñ Reading</button>
      <button class="status-tab" data-status="tbr" onclick="setStatus('tbr')">üìã TBR</button>
    </div>
    <select id="genreSelect"><option value="">All genres</option></select>
    <select id="triggerSelect"><option value="">All content</option></select>
    <select id="seriesSelect"><option value="">All series</option></select>
    <select id="sortSelect">
      <option value="recent">Recently added</option>
      <option value="rating">Top rated</option>
      <option value="title">A ‚Äì Z</option>
      <option value="author">By author</option>
      <option value="series">By series</option>
    </select>
    <button class="btn btn-primary" onclick="openAddModal()">+ Add Book</button>
    <button class="btn btn-ghost btn-sm" onclick="window.location='/api/export/csv'" title="Download CSV">‚¨á CSV</button>
    <button class="btn btn-ghost btn-sm" onclick="openScanner()" title="Scan ISBN barcode">üì∑ Scan</button>
  </div>

  <div class="filter-tags" id="filterTags"></div>

  <div class="stats-bar" id="statsBar">
    <span>üìö <span class="stat-val" id="statBooks">0</span> books</span>
    <span>‚≠ê <span class="stat-val" id="statRatings">0</span> ratings</span>
    <span>üìñ <span class="stat-val" id="statReading">0</span> reading</span>
    <span>üìã <span class="stat-val" id="statTBR">0</span> to read</span>
  </div>

  <div class="grid" id="booksGrid"></div>
</div>

<!-- ‚îÄ‚îÄ STATS PAGE ‚îÄ‚îÄ -->
<div id="page-stats" class="page">
  <div class="stats-page">
    <h2>Reading Stats</h2>
    <div class="stats-grid" id="statsCards"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;flex-wrap:wrap;" id="statsColumns">
      <div>
        <div class="stats-section">
          <h3>Top Rated Books</h3>
          <div id="topRatedList"></div>
        </div>
        <div class="stats-section">
          <h3>Readers</h3>
          <div id="readersList"></div>
        </div>
      </div>
      <div>
        <div class="stats-section">
          <h3>Top Genres</h3>
          <div id="genreBarList"></div>
        </div>
        <div class="stats-section">
          <h3>Library Status</h3>
          <div id="statusBreakdown"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ACTIVITY PAGE ‚îÄ‚îÄ -->
<div id="page-activity" class="page">
  <div class="activity-page">
    <h2>Recent Activity</h2>
    <div id="activityFeed"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ BOOK DETAIL MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('detailModal')">‚úï</button>
    <div id="detailContent"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ADD BOOK MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addModal')">‚úï</button>
    <div class="add-book-form">
      <h2>Add a Book</h2>

      <div class="form-group">
        <label>Title or ISBN</label>
        <div class="lookup-row">
          <input type="text" id="addTitle" placeholder="Title or scan/type an ISBN‚Ä¶">
          <button class="btn btn-ghost" onclick="lookupBook()" id="lookupBtn">Look Up</button>
        </div>
      </div>
      <div class="form-group">
        <label>Author</label>
        <input type="text" id="addAuthor" placeholder="Author name‚Ä¶">
      </div>

      <div class="lookup-preview" id="lookupPreview">
        <img id="previewCover" src="" alt="cover">
        <div class="lookup-preview-info">
          <div class="lookup-title" id="previewTitle"></div>
          <div class="lookup-author" id="previewAuthor"></div>
          <div id="previewGenres" style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.4rem;"></div>
        </div>
      </div>

      <div class="form-group">
        <label>Status</label>
        <div class="status-select-row">
          <button class="status-opt active" data-s="finished" onclick="setAddStatus('finished')">‚úì Finished</button>
          <button class="status-opt" data-s="reading" onclick="setAddStatus('reading')">üìñ Reading</button>
          <button class="status-opt" data-s="tbr" onclick="setAddStatus('tbr')">üìã Want to Read</button>
        </div>
      </div>

      <div class="form-row">
        <div style="flex:2">
          <label style="font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Series Name</label>
          <input type="text" id="addSeries" placeholder="e.g. Haunting Adeline">
        </div>
        <div style="flex:1">
          <label style="font-family:'Josefin Sans',sans-serif;font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted);display:block;margin-bottom:0.3rem;">Book #</label>
          <input type="number" id="addSeriesOrder" placeholder="1" min="0" step="0.5">
        </div>
      </div>

      <div class="form-group">
        <label>Recommended By <span style="opacity:0.5">(optional)</span></label>
        <input type="text" id="addRecommendedBy" placeholder="Who suggested this?">
      </div>

      <div class="form-group">
        <label>Cover Image URL <span style="opacity:0.5">(auto-filled)</span></label>
        <input type="text" id="addCover" placeholder="https://‚Ä¶">
      </div>
      <div class="form-group">
        <label>Synopsis <span style="opacity:0.5">(auto-filled)</span></label>
        <textarea id="addSynopsis" rows="3" placeholder="Book description‚Ä¶"></textarea>
      </div>
      <div class="form-group">
        <label>Genres <span style="opacity:0.5">‚Äî press Enter to add</span></label>
        <div class="tag-editor" id="genreEditor" onclick="this.querySelector('.te-input').focus()">
          <input class="te-input" id="genreInput" placeholder="e.g. Dark Romance" onkeydown="tagKeydown(event,'genres')">
        </div>
      </div>
      <div class="form-group">
        <label>Trigger Warnings <span style="opacity:0.5">‚Äî press Enter to add</span></label>
        <div class="tag-editor" id="triggerEditor" onclick="this.querySelector('.te-input').focus()">
          <input class="te-input" id="triggerInput" placeholder="e.g. Dubcon" onkeydown="tagKeydown(event,'triggers')">
        </div>
      </div>

      <div style="display:flex;gap:0.65rem;margin-top:1.25rem;">
        <button class="btn btn-primary" onclick="submitBook()" id="submitBookBtn">Add to Library</button>
        <button class="btn btn-ghost" onclick="closeModal('addModal')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SCANNER MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="scanModal">
  <div class="modal" style="max-width:480px;">
    <button class="modal-close" onclick="closeScanner()">‚úï</button>
    <div class="scanner-area">
      <h2>Scan ISBN Barcode</h2>
      <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:1rem;">Point your camera at the barcode on the back of a book.</p>
      <video id="scannerVideo" autoplay playsinline></video>
      <canvas id="scannerCanvas" style="display:none;"></canvas>
      <div class="scan-result" id="scanResult" style="display:none;"></div>
      <p style="margin-top:1rem;color:var(--text-muted);font-size:0.85rem;font-style:italic;">
        Or type the ISBN manually in the Add Book form.
      </p>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let books = [], filters = { genre:'', trigger:'', search:'', sort:'recent', status:'all', series:'' };
let pendingGenres = [], pendingTriggers = [], pendingStatus = 'finished';
let lookupData = null, currentBookId = null, ratingStars = 0;
let readers = [], activeReader = '';
let scanStream = null, scanInterval = null;

// ‚îÄ‚îÄ Reader Profiles (localStorage) ‚îÄ‚îÄ
function loadReaders() {
  try { readers = JSON.parse(localStorage.getItem('shelf_readers') || '[]'); } catch(e) { readers = []; }
  try { activeReader = localStorage.getItem('shelf_active_reader') || ''; } catch(e) { activeReader = ''; }
  if (readers.length && !readers.includes(activeReader)) activeReader = readers[0];
  renderProfiles();
}

function saveReaders() {
  try {
    localStorage.setItem('shelf_readers', JSON.stringify(readers));
    localStorage.setItem('shelf_active_reader', activeReader);
  } catch(e) {}
}

function renderProfiles() {
  const el = document.getElementById('profileChips');
  el.innerHTML = readers.map(r =>
    `<span class="profile-chip${r===activeReader?' active':''}" onclick="selectReader('${esc(r)}')">${esc(r)}</span>`
  ).join('');
}

function selectReader(name) {
  activeReader = name;
  saveReaders();
  renderProfiles();
}

function addReader() {
  const name = prompt('Enter a name for the new reader:');
  if (!name || !name.trim()) return;
  const n = name.trim();
  if (readers.includes(n)) return toast('That reader already exists', 'error');
  readers.push(n);
  activeReader = n;
  saveReaders();
  renderProfiles();
}

// ‚îÄ‚îÄ Pages ‚îÄ‚îÄ
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.page === page));
  document.getElementById('page-' + page).classList.add('active');
  if (page === 'stats') loadStats();
  if (page === 'activity') loadActivity();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  loadReaders();
  await Promise.all([loadBooks(), loadFilters()]);

  document.getElementById('searchInput').addEventListener('input', debounce(e => {
    filters.search = e.target.value; loadBooks();
  }, 300));
  document.getElementById('genreSelect').addEventListener('change', e => { filters.genre = e.target.value; loadBooks(); syncFilterTags(); });
  document.getElementById('triggerSelect').addEventListener('change', e => { filters.trigger = e.target.value; loadBooks(); syncFilterTags(); });
  document.getElementById('seriesSelect').addEventListener('change', e => { filters.series = e.target.value; loadBooks(); });
  document.getElementById('sortSelect').addEventListener('change', e => { filters.sort = e.target.value; loadBooks(); });
}

function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

// ‚îÄ‚îÄ Books ‚îÄ‚îÄ
async function loadBooks() {
  const params = new URLSearchParams();
  if (filters.genre) params.set('genre', filters.genre);
  if (filters.trigger) params.set('trigger', filters.trigger);
  if (filters.search) params.set('search', filters.search);
  if (filters.sort) params.set('sort', filters.sort);
  if (filters.status && filters.status !== 'all') params.set('status', filters.status);
  if (filters.series) params.set('series', filters.series);

  const res = await fetch(`${API}/api/books?${params}`);
  books = await res.json();
  renderGrid();
  updateStats();
}

async function loadFilters() {
  const res = await fetch(`${API}/api/filters`);
  const data = await res.json();

  const gs = document.getElementById('genreSelect');
  gs.innerHTML = '<option value="">All genres</option>' + data.genres.map(g => `<option value="${esc(g)}">${esc(g)}</option>`).join('');

  const ts = document.getElementById('triggerSelect');
  ts.innerHTML = '<option value="">All content</option>' + data.triggers.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');

  const ss = document.getElementById('seriesSelect');
  ss.innerHTML = '<option value="">All series</option>' + data.series.map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join('');

  renderFilterTags(data.genres, data.triggers, data.series);
}

function renderFilterTags(genres, triggers, series) {
  const el = document.getElementById('filterTags');
  const genreTags = genres.map(g => `<span class="tag${filters.genre===g?' active':''}" onclick="setFilter('genre','${esc(g)}')">${esc(g)}</span>`);
  const triggerTags = triggers.map(t => `<span class="tag trigger${filters.trigger===t?' active':''}" onclick="setFilter('trigger','${esc(t)}')" title="Trigger warning">‚ö† ${esc(t)}</span>`);
  const seriesTags = (series||[]).map(s => `<span class="tag series-tag${filters.series===s?' active':''}" onclick="setFilter('series','${esc(s)}')" title="Series">üìó ${esc(s)}</span>`);
  const all = [...genreTags, ...triggerTags, ...seriesTags];
  el.innerHTML = all.length ? all.join('') : '<span style="font-family:Josefin Sans,sans-serif;font-size:0.6rem;letter-spacing:0.1em;color:var(--text-muted);text-transform:uppercase">Genres appear as books are added</span>';
}

function syncFilterTags() {
  document.querySelectorAll('.filter-tags .tag').forEach(t => {
    const isTrigger = t.classList.contains('trigger');
    const isSeries = t.classList.contains('series-tag');
    const val = t.textContent.replace('‚ö† ','').replace('üìó ','').trim();
    if (isTrigger) t.classList.toggle('active', filters.trigger === val);
    else if (isSeries) t.classList.toggle('active', filters.series === val);
    else t.classList.toggle('active', filters.genre === val);
  });
}

function setFilter(type, val) {
  if (type === 'series') {
    filters.series = filters.series === val ? '' : val;
    document.getElementById('seriesSelect').value = filters.series;
  } else if (type === 'genre') {
    filters.genre = filters.genre === val ? '' : val;
    document.getElementById('genreSelect').value = filters.genre;
  } else {
    filters.trigger = filters.trigger === val ? '' : val;
    document.getElementById('triggerSelect').value = filters.trigger;
  }
  syncFilterTags();
  loadBooks();
}

function setStatus(s) {
  filters.status = s;
  document.querySelectorAll('.status-tab').forEach(t => t.classList.toggle('active', t.dataset.status === s));
  loadBooks();
}

function updateStats() {
  document.getElementById('statBooks').textContent = books.length;
  document.getElementById('statRatings').textContent = books.reduce((s,b) => s + (b.rating_count||0), 0);
  document.getElementById('statReading').textContent = books.filter(b => b.status==='reading').length;
  document.getElementById('statTBR').textContent = books.filter(b => b.status==='tbr').length;
}

function renderGrid() {
  const grid = document.getElementById('booksGrid');
  if (!books.length) {
    grid.innerHTML = `<div class="empty-state"><div class="icon">üìñ</div><p>No books found ‚Äî add one to start the shelf</p></div>`;
    return;
  }
  grid.innerHTML = books.map(b => {
    const avgStars = renderStarsHTML(b.avg_rating || 0, 'stars-display');
    const genres = (b.genres||[]).slice(0,3).map(g => `<span class="genre-chip${['Dark Romance','Romance'].includes(g)?' highlight':''}">${esc(g)}</span>`).join('');
    const cover = b.cover_url ? `<img class="book-cover" src="${esc(b.cover_url)}" alt="${esc(b.title)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">` : '';
    const ph = `<div class="book-cover-placeholder" style="${b.cover_url?'display:none':''}">üìö</div>`;
    const badge = b.status==='reading' ? '<span class="status-badge reading">Reading</span>'
                : b.status==='tbr' ? '<span class="status-badge tbr">TBR</span>' : '';
    const series = b.series_name ? `<div class="card-series">üìó ${esc(b.series_name)}${b.series_order?' #'+b.series_order:''}</div>` : '';
    return `<div class="book-card" onclick="openDetail(${b.id})">
      ${cover}${ph}${badge}
      <div class="card-body">
        <div class="card-title">${esc(b.title)}</div>
        ${series}
        <div class="card-author">${esc(b.author)}</div>
        <div class="card-rating">${avgStars}<span class="rating-count">${b.rating_count?b.rating_count+' rating'+(b.rating_count>1?'s':''):'No ratings'}</span></div>
        <div class="card-genres">${genres}</div>
      </div>
      <div class="card-actions">
        <button class="action-btn" onclick="event.stopPropagation();openRating(${b.id})">Rate</button>
        <button class="action-btn" onclick="event.stopPropagation();deleteBook(${b.id},'${esc(b.title)}')">Remove</button>
      </div>
    </div>`;
  }).join('');
}

function renderStarsHTML(avg, cls) {
  return `<div class="${cls}">${[1,2,3,4,5].map(i=>`<span class="s${i<=Math.round(avg)?' on':''}">‚òÖ</span>`).join('')}</div>`;
}

// ‚îÄ‚îÄ Book Detail ‚îÄ‚îÄ
async function openDetail(id) {
  currentBookId = id;
  const res = await fetch(`${API}/api/books/${id}`);
  const book = await res.json();
  renderDetail(book);
  openModal('detailModal');
}

function renderDetail(book) {
  const ratings = book.ratings || [];
  const avgRating = ratings.length ? ratings.reduce((s,r) => s+r.stars, 0) / ratings.length : 0;
  const coverHtml = book.cover_url ? `<img src="${esc(book.cover_url)}" alt="${esc(book.title)}">` : `<div class="cover-ph">üìö</div>`;

  const genres = (book.genres||[]).map(g => `<span class="meta-pill">${esc(g)}</span>`).join('');
  const triggers = (book.trigger_warnings||[]).map(t => `<span class="meta-pill tw">‚ö† ${esc(t)}</span>`).join('');
  const statusClass = book.status==='reading'?'status-reading':book.status==='tbr'?'status-tbr':'';
  const statusLabel = book.status==='reading'?'üìñ Currently Reading':book.status==='tbr'?'üìã Want to Read':'‚úì Finished';

  const meta = [];
  if (book.published_year) meta.push(`<span class="meta-pill">${book.published_year}</span>`);
  if (book.page_count) meta.push(`<span class="meta-pill">${book.page_count} pages</span>`);
  meta.push(`<span class="meta-pill ${statusClass}">${statusLabel}</span>`);
  if (book.recommended_by) meta.push(`<span class="meta-pill">üí¨ Rec'd by ${esc(book.recommended_by)}</span>`);

  const ratingsList = ratings.length
    ? ratings.map(r => `<div class="rating-item">
        <div class="rating-header">
          <div style="display:flex;align-items:center;gap:0.5rem">
            <span class="reader-name">${esc(r.reader_name)}</span>${renderStarsHTML(r.stars,'stars-display')}
          </div>
          <div style="display:flex;align-items:center">
            <span class="rating-date">${new Date(r.rated_at).toLocaleDateString()}</span>
            <button class="delete-btn" onclick="deleteRating(${r.id})" title="Remove">‚úï</button>
          </div>
        </div>
        ${r.blurb?`<div class="rating-blurb">"${esc(r.blurb)}"</div>`:''}
      </div>`).join('')
    : '<p style="color:var(--text-muted);font-style:italic;font-size:0.9rem">No ratings yet ‚Äî be the first!</p>';

  // Quick status change buttons
  const statusBtns = ['finished','reading','tbr'].map(s =>
    `<button class="btn btn-ghost btn-sm" onclick="quickStatusChange(${book.id},'${s}')" style="${book.status===s?'border-color:var(--accent);color:var(--accent)':''}">${s==='finished'?'‚úì Finished':s==='reading'?'üìñ Reading':'üìã TBR'}</button>`
  ).join('');

  document.getElementById('detailContent').innerHTML = `
    <div class="book-detail">
      <div class="book-detail-cover">${coverHtml}</div>
      <div class="book-detail-info">
        ${book.series_name?`<div class="detail-series">üìó ${esc(book.series_name)}${book.series_order?' ‚Äî Book #'+book.series_order:''}</div>`:''}
        <div class="detail-title">${esc(book.title)}</div>
        <div class="detail-author">by ${esc(book.author)}</div>
        <div class="detail-meta">${meta.join('')}</div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.85rem;">${statusBtns}</div>
        ${ratings.length?`<div class="avg-rating-display">
          ${renderStarsHTML(avgRating,'avg-stars-big')}
          <div><div class="avg-num">${avgRating.toFixed(1)}</div><div class="avg-label">${ratings.length} rating${ratings.length>1?'s':''}</div></div>
        </div>`:''}
        ${book.kindle_url?`<a class="kindle-link" href="${esc(book.kindle_url)}" target="_blank" rel="noopener">üì± Find on Kindle Unlimited</a>`:''}
        ${genres||triggers?`<div class="detail-meta">${genres}${triggers}</div>`:''}
        ${book.synopsis?`<div class="synopsis">${esc(book.synopsis).substring(0,600)}${book.synopsis.length>600?'‚Ä¶':''}</div>`:''}
        <div class="section-label">Ratings</div>
        <div class="rating-list">${ratingsList}</div>
        <div class="section-label">Add Your Rating</div>
        <div class="add-rating-form">
          <div class="form-row">
            <input type="text" id="raterName" placeholder="Your name‚Ä¶" value="${esc(activeReader)}" style="flex:1">
          </div>
          <div class="star-picker" id="starPicker">
            ${[1,2,3,4,5].map(i=>`<span class="sp" data-val="${i}" onclick="setStar(${i})">‚òÖ</span>`).join('')}
          </div>
          <div class="form-row"><textarea id="raterBlurb" placeholder="What did you think? (optional)‚Ä¶"></textarea></div>
          <button class="btn btn-primary" onclick="submitRating(${book.id})">Save Rating</button>
        </div>
      </div>
    </div>`;
  ratingStars = 0;
}

async function quickStatusChange(id, status) {
  await fetch(`${API}/api/books/${id}`, {
    method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status})
  });
  loadBooks();
  openDetail(id);
  toast('Status updated!', 'success');
}

function setStar(n) {
  ratingStars = n;
  document.querySelectorAll('.star-picker .sp').forEach((s,i) => s.classList.toggle('active', i < n));
}

async function submitRating(bookId) {
  const name = document.getElementById('raterName').value.trim();
  if (!name) return toast('Please enter your name', 'error');
  if (!ratingStars) return toast('Please pick a star rating', 'error');

  // Auto-add reader to profiles
  if (name && !readers.includes(name)) {
    readers.push(name); activeReader = name; saveReaders(); renderProfiles();
  } else if (name) { activeReader = name; saveReaders(); renderProfiles(); }

  const blurb = document.getElementById('raterBlurb').value.trim();
  const res = await fetch(`${API}/api/books/${bookId}/ratings`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({reader_name:name, stars:ratingStars, blurb})
  });
  if (res.ok) { toast('Rating saved!', 'success'); openDetail(bookId); loadBooks(); }
  else toast('Failed to save rating', 'error');
}

async function deleteRating(ratingId) {
  if (!confirm('Remove this rating?')) return;
  await fetch(`${API}/api/ratings/${ratingId}`, {method:'DELETE'});
  openDetail(currentBookId); loadBooks();
}

async function openRating(id) {
  currentBookId = id;
  await openDetail(id);
  setTimeout(() => { const f = document.querySelector('.add-rating-form'); if (f) f.scrollIntoView({behavior:'smooth',block:'center'}); }, 100);
}

async function deleteBook(id, title) {
  if (!confirm(`Remove "${title}" from the library?`)) return;
  await fetch(`${API}/api/books/${id}`, {method:'DELETE'});
  await loadBooks(); await loadFilters();
  toast(`"${title}" removed`, 'success');
}

// ‚îÄ‚îÄ Add Book ‚îÄ‚îÄ
function openAddModal() {
  ['addTitle','addAuthor','addCover','addSynopsis','addSeries','addSeriesOrder','addRecommendedBy'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  document.getElementById('lookupPreview').classList.remove('visible');
  pendingGenres = []; pendingTriggers = []; pendingStatus = 'finished'; lookupData = null;
  renderTagEditor('genres'); renderTagEditor('triggers');
  setAddStatus('finished');
  if (activeReader) document.getElementById('addRecommendedBy').value = '';
  openModal('addModal');
}

function setAddStatus(s) {
  pendingStatus = s;
  document.querySelectorAll('.status-opt').forEach(b => b.classList.toggle('active', b.dataset.s === s));
}

async function lookupBook() {
  const title = document.getElementById('addTitle').value.trim();
  if (!title) return toast('Enter a title or ISBN first', 'error');
  const author = document.getElementById('addAuthor').value.trim();
  const btn = document.getElementById('lookupBtn');
  btn.innerHTML = 'Looking up <span class="spinner"></span>';
  btn.disabled = true;
  try {
    const res = await fetch(`${API}/api/lookup?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}`);
    lookupData = await res.json();
    document.getElementById('addTitle').value = lookupData.title || title;
    document.getElementById('addAuthor').value = lookupData.author || author;
    document.getElementById('addCover').value = lookupData.cover_url || '';
    document.getElementById('addSynopsis').value = lookupData.synopsis || '';
    pendingGenres = lookupData.genres || [];
    pendingTriggers = lookupData.trigger_warnings || [];
    renderTagEditor('genres'); renderTagEditor('triggers');

    const preview = document.getElementById('lookupPreview');
    document.getElementById('previewTitle').textContent = lookupData.title;
    document.getElementById('previewAuthor').textContent = lookupData.author;
    const img = document.getElementById('previewCover');
    if (lookupData.cover_url) { img.src = lookupData.cover_url; img.style.display = 'block'; }
    else img.style.display = 'none';
    document.getElementById('previewGenres').innerHTML = [...pendingGenres,...pendingTriggers.map(t=>'‚ö† '+t)].map(g=>`<span class="genre-chip">${esc(g)}</span>`).join('');
    preview.classList.add('visible');
    toast('Book found!', 'success');
  } catch(e) { toast('Lookup failed ‚Äî fill in details manually', 'error'); }
  finally { btn.textContent = 'Look Up'; btn.disabled = false; }
}

async function submitBook() {
  const title = document.getElementById('addTitle').value.trim();
  if (!title) return toast('Title is required', 'error');
  const btn = document.getElementById('submitBookBtn');
  btn.innerHTML = 'Adding‚Ä¶ <span class="spinner"></span>'; btn.disabled = true;

  const body = {
    title, author:document.getElementById('addAuthor').value.trim(),
    cover_url:document.getElementById('addCover').value.trim()||null,
    synopsis:document.getElementById('addSynopsis').value.trim(),
    genres:pendingGenres, trigger_warnings:pendingTriggers,
    status:pendingStatus,
    series_name:document.getElementById('addSeries').value.trim()||null,
    series_order:document.getElementById('addSeriesOrder').value ? parseFloat(document.getElementById('addSeriesOrder').value) : null,
    recommended_by:document.getElementById('addRecommendedBy').value.trim()||null,
    ...(lookupData ? {isbn:lookupData.isbn,open_library_key:lookupData.open_library_key,published_year:lookupData.published_year,page_count:lookupData.page_count,kindle_url:lookupData.kindle_url} : {})
  };

  try {
    const res = await fetch(`${API}/api/books`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    if (res.status === 409) { toast('Already in the library!', 'error'); return; }
    if (!res.ok) throw new Error('Server error');
    const newBook = await res.json();
    closeModal('addModal');
    await loadBooks(); await loadFilters();
    toast(`"${newBook.title}" added!`, 'success');
    setTimeout(() => openDetail(newBook.id), 350);
  } catch(e) { toast('Failed to add book: ' + e.message, 'error'); }
  finally { btn.textContent = 'Add to Library'; btn.disabled = false; }
}

// ‚îÄ‚îÄ Tag Editor ‚îÄ‚îÄ
function renderTagEditor(type) {
  const arr = type === 'genres' ? pendingGenres : pendingTriggers;
  const editorId = type === 'genres' ? 'genreEditor' : 'triggerEditor';
  const inputId = type === 'genres' ? 'genreInput' : 'triggerInput';
  const editor = document.getElementById(editorId);
  const tags = arr.map((t,i) => `<span class="te-tag">${esc(t)}<span class="te-remove" onclick="removeTag('${type}',${i})">‚úï</span></span>`).join('');
  editor.innerHTML = tags + `<input class="te-input" id="${inputId}" placeholder="${type==='genres'?'e.g. Dark Romance':'e.g. Dubcon'}" onkeydown="tagKeydown(event,'${type}')">`;
}

function tagKeydown(e, type) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,$/, '');
    if (val) { if (type==='genres') pendingGenres.push(val); else pendingTriggers.push(val); renderTagEditor(type); }
  }
}

function removeTag(type, idx) {
  if (type==='genres') pendingGenres.splice(idx,1); else pendingTriggers.splice(idx,1);
  renderTagEditor(type);
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
async function loadStats() {
  const res = await fetch(`${API}/api/stats`);
  const s = await res.json();

  const statusMap = {};
  (s.byStatus||[]).forEach(r => statusMap[r.status] = r.n);

  document.getElementById('statsCards').innerHTML = `
    <div class="stat-card"><div class="stat-card-num">${s.totalBooks}</div><div class="stat-card-label">Books in library</div></div>
    <div class="stat-card"><div class="stat-card-num">${s.totalRatings}</div><div class="stat-card-label">Total ratings</div></div>
    <div class="stat-card"><div class="stat-card-num" style="color:var(--reading)">${statusMap['reading']||0}</div><div class="stat-card-label">Currently reading</div></div>
    <div class="stat-card"><div class="stat-card-num" style="color:var(--tbr)">${statusMap['tbr']||0}</div><div class="stat-card-label">Want to read</div></div>
  `;

  document.getElementById('topRatedList').innerHTML = (s.topRated||[]).map((b,i) => `
    <div class="top-book-row">
      <div style="font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--text-muted);width:24px">${i+1}</div>
      ${b.cover_url?`<img class="top-book-cover" src="${esc(b.cover_url)}" alt="">` : `<div class="top-book-cover" style="display:flex;align-items:center;justify-content:center;font-size:1.2rem">üìö</div>`}
      <div class="top-book-info">
        <div class="top-book-title">${esc(b.title)}</div>
        <div class="top-book-author">${esc(b.author)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.1rem">${b.avg}</div>
        <div style="font-family:'Josefin Sans',sans-serif;font-size:0.58rem;color:var(--text-muted)">${b.cnt} rating${b.cnt>1?'s':''}</div>
      </div>
    </div>`).join('') || '<p style="color:var(--text-muted);font-style:italic;font-size:0.9rem">Rate some books to see top rated!</p>';

  document.getElementById('readersList').innerHTML = (s.byReader||[]).map(r => `
    <div class="reader-row">
      <div class="reader-avatar">${r.reader_name.charAt(0).toUpperCase()}</div>
      <div class="reader-info">
        <div class="reader-info-name">${esc(r.reader_name)}</div>
        <div class="reader-info-sub">${r.ratings_count} rating${r.ratings_count>1?'s':''} ¬∑ avg ${r.avg_stars} ‚òÖ</div>
      </div>
    </div>`).join('') || '<p style="color:var(--text-muted);font-style:italic;font-size:0.9rem">No ratings yet!</p>';

  const maxGenre = Math.max(...(s.topGenres||[]).map(g => g.count), 1);
  document.getElementById('genreBarList').innerHTML = (s.topGenres||[]).map(g => `
    <div class="genre-bar-row">
      <div class="genre-bar-label">${esc(g.genre)}</div>
      <div class="genre-bar-track"><div class="genre-bar-fill" style="width:${Math.round(g.count/maxGenre*100)}%"></div></div>
      <div class="genre-bar-count">${g.count}</div>
    </div>`).join('') || '<p style="color:var(--text-muted);font-style:italic;font-size:0.9rem">No genres yet!</p>';

  document.getElementById('statusBreakdown').innerHTML = [
    {label:'‚úì Finished', val:statusMap['finished']||0, color:'var(--finished)'},
    {label:'üìñ Reading', val:statusMap['reading']||0, color:'var(--reading)'},
    {label:'üìã To Read', val:statusMap['tbr']||0, color:'var(--tbr)'},
  ].map(row => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.6rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:0.5rem;">
      <span style="font-family:'Josefin Sans',sans-serif;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:${row.color}">${row.label}</span>
      <span style="font-family:'Playfair Display',serif;font-size:1.2rem;color:${row.color}">${row.val}</span>
    </div>`).join('');
}

// ‚îÄ‚îÄ Activity ‚îÄ‚îÄ
async function loadActivity() {
  const res = await fetch(`${API}/api/activity`);
  const items = await res.json();
  const icons = { book_added:'üìö', rating_added:'‚≠ê', book_removed:'üóë' };
  const labels = {
    book_added: a => `<strong>${esc(a.book_title)}</strong> was added to the library${a.reader_name?' by <strong>'+esc(a.reader_name)+'</strong>':''}`,
    rating_added: a => `<strong>${esc(a.reader_name)}</strong> rated <strong>${esc(a.book_title)}</strong> ${a.detail}`,
    book_removed: a => `<strong>${esc(a.book_title)}</strong> was removed from the library`,
  };
  document.getElementById('activityFeed').innerHTML = items.length
    ? items.map(a => `
      <div class="activity-item">
        <div class="activity-icon ${a.type}">${icons[a.type]||'‚Ä¢'}</div>
        <div class="activity-body">
          <div class="activity-text">${(labels[a.type]||(() => esc(a.type)))(a)}</div>
          <div class="activity-time">${timeAgo(a.created_at)}</div>
        </div>
      </div>`).join('')
    : '<p style="color:var(--text-muted);font-style:italic">No activity yet ‚Äî start adding books!</p>';
}

function timeAgo(dt) {
  const diff = (Date.now() - new Date(dt + 'Z').getTime()) / 1000;
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff/60) + 'm ago';
  if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return Math.floor(diff/86400) + 'd ago';
}

// ‚îÄ‚îÄ Barcode Scanner ‚îÄ‚îÄ
function openScanner() {
  openModal('scanModal');
  startCamera();
}

async function startCamera() {
  try {
    scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    const video = document.getElementById('scannerVideo');
    video.srcObject = scanStream;

    // Load ZXing for barcode decoding
    if (!window.ZXing) {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.21.1/zxing.min.js';
      script.onload = () => startScanLoop();
      document.head.appendChild(script);
    } else {
      startScanLoop();
    }
  } catch(e) {
    document.getElementById('scanResult').style.display = 'block';
    document.getElementById('scanResult').textContent = 'Camera access denied. Please type the ISBN manually.';
  }
}

function startScanLoop() {
  const video = document.getElementById('scannerVideo');
  const canvas = document.getElementById('scannerCanvas');
  const ctx = canvas.getContext('2d');

  try {
    const codeReader = new ZXing.BrowserBarcodeReader();
    codeReader.decodeFromVideoDevice(null, 'scannerVideo', (result, err) => {
      if (result) {
        const isbn = result.getText();
        closeScanner();
        openAddModal();
        document.getElementById('addTitle').value = isbn;
        lookupBook();
      }
    });
  } catch(e) {
    // Fallback: manual frame scanning
    scanInterval = setInterval(() => {
      if (!video.videoWidth) return;
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
    }, 500);
  }
}

function closeScanner() {
  if (scanStream) { scanStream.getTracks().forEach(t => t.stop()); scanStream = null; }
  if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
  closeModal('scanModal');
}

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }

document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target===el) { if (el.id==='scanModal') closeScanner(); else closeModal(el.id); } });
});
document.addEventListener('keydown', e => {
  if (e.key==='Escape') { closeScanner(); document.querySelectorAll('.modal-overlay.open').forEach(m => closeModal(m.id)); }
});

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
let toastTimer;
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast show ' + type;
  clearTimeout(toastTimer); toastTimer = setTimeout(() => el.className='toast', 3000);
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

init();
</script>
</body>
</html>
