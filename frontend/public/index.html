<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Family Shelf</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Josefin+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0b0e;
    --surface: #141018;
    --surface2: #1c1822;
    --border: #2a2235;
    --accent: #c0392b;
    --accent2: #8b1a1a;
    --accent-glow: rgba(192,57,43,0.15);
    --gold: #c9a84c;
    --gold-dim: #7a6130;
    --text: #e8e0d5;
    --text-dim: #8a7f8a;
    --text-muted: #4a4050;
    --star-on: #c9a84c;
    --star-off: #2a2235;
    --radius: 4px;
    --shadow: 0 8px 32px rgba(0,0,0,0.6);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Crimson Pro', Georgia, serif;
    font-size: 18px;
    line-height: 1.6;
    min-height: 100vh;
    background-image: 
      radial-gradient(ellipse 60% 40% at 50% 0%, rgba(140,20,20,0.08) 0%, transparent 70%),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Cpath d='M0 0h60v60H0z' fill='none'/%3E%3Ccircle cx='30' cy='30' r='0.4' fill='%23ffffff08'/%3E%3C/svg%3E");
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    text-align: center;
    padding: 3rem 2rem 2rem;
    position: relative;
    border-bottom: 1px solid var(--border);
  }

  header::before {
    content: '';
    position: absolute;
    bottom: 0; left: 50%; transform: translateX(-50%);
    width: 200px; height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .site-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.4rem, 5vw, 4rem);
    font-weight: 700;
    letter-spacing: 0.02em;
    color: var(--text);
    line-height: 1.1;
  }

  .site-title span { color: var(--accent); }

  .site-subtitle {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-top: 0.5rem;
  }

  /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    padding: 1.25rem 2rem;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(12px);
  }

  .search-wrap {
    flex: 1;
    min-width: 200px;
    position: relative;
  }

  .search-wrap input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.55rem 1rem 0.55rem 2.5rem;
    font-family: 'Crimson Pro', serif;
    font-size: 1rem;
    border-radius: var(--radius);
    outline: none;
    transition: border-color 0.2s;
  }

  .search-wrap input:focus { border-color: var(--accent); }

  .search-wrap::before {
    content: '‚åï';
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 1.2rem;
    pointer-events: none;
  }

  select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.55rem 2rem 0.55rem 0.9rem;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    border-radius: var(--radius);
    outline: none;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238a7f8a'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.7rem center;
    transition: border-color 0.2s;
  }

  select:focus { border-color: var(--accent); }

  .btn {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.72rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.6rem 1.4rem;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover { background: #a93226; transform: translateY(-1px); }

  .btn-ghost {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    padding: 0.75rem 2rem;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    min-height: 44px;
  }

  .tag {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.63rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
    background: var(--surface);
  }

  .tag:hover { border-color: var(--accent); color: var(--accent); }
  .tag.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
  .tag.trigger { border-color: var(--gold-dim); color: var(--gold); }
  .tag.trigger.active { background: rgba(201,168,76,0.1); }

  /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
    padding: 2rem;
    max-width: 1600px;
    margin: 0 auto;
  }

  .book-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    position: relative;
  }

  .book-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow);
    border-color: var(--accent);
  }

  .book-card:hover::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 60%, var(--accent-glow));
    pointer-events: none;
  }

  .book-cover {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    display: block;
    background: var(--surface2);
  }

  .book-cover-placeholder {
    width: 100%;
    aspect-ratio: 2/3;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--surface2), var(--border));
    font-size: 3rem;
    color: var(--text-muted);
  }

  .card-body {
    padding: 0.85rem;
  }

  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1.3;
    margin-bottom: 0.2rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-author {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .card-rating {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .stars-display {
    display: flex;
    gap: 1px;
  }

  .stars-display .s {
    font-size: 0.85rem;
    color: var(--star-off);
    transition: color 0.15s;
  }

  .stars-display .s.on { color: var(--star-on); }

  .rating-count {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.6rem;
    color: var(--text-muted);
    letter-spacing: 0.05em;
  }

  .card-genres {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.6rem;
  }

  .genre-chip {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.55rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.15rem 0.5rem;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--text-muted);
  }

  .genre-chip.highlight { border-color: var(--accent2); color: var(--accent); }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    overflow-y: auto;
    padding: 2rem 1rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 100%;
    max-width: 800px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.8);
    position: relative;
    transform: translateY(20px);
    transition: transform 0.25s;
  }

  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-close {
    position: absolute;
    top: 1rem; right: 1rem;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    line-height: 1;
    transition: color 0.15s;
    z-index: 2;
  }

  .modal-close:hover { color: var(--accent); }

  /* Book detail modal */
  .book-detail {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 0;
  }

  @media (max-width: 600px) {
    .book-detail { grid-template-columns: 1fr; }
  }

  .book-detail-cover {
    position: relative;
  }

  .book-detail-cover img, .book-detail-cover .cover-ph {
    width: 100%;
    height: 100%;
    min-height: 300px;
    object-fit: cover;
    border-radius: 8px 0 0 8px;
    display: block;
  }

  .book-detail-cover .cover-ph {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    background: var(--surface2);
    border-radius: 8px 0 0 8px;
  }

  .book-detail-info {
    padding: 2rem;
    overflow-y: auto;
    max-height: 85vh;
  }

  .detail-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 0.25rem;
  }

  .detail-author {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.72rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 1rem;
  }

  .detail-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .meta-pill {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.25rem 0.7rem;
    border-radius: 20px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .meta-pill.tw { border-color: var(--gold-dim); color: var(--gold); background: rgba(201,168,76,0.05); }

  .avg-rating-display {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    padding: 0.75rem;
    background: var(--surface2);
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  .avg-stars-big { display: flex; gap: 3px; }
  .avg-stars-big .s { font-size: 1.3rem; }

  .avg-num {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: var(--gold);
  }

  .avg-label {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.62rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .kindle-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--gold);
    text-decoration: none;
    border: 1px solid var(--gold-dim);
    padding: 0.4rem 0.9rem;
    border-radius: var(--radius);
    margin-bottom: 1rem;
    transition: all 0.15s;
  }

  .kindle-link:hover { background: rgba(201,168,76,0.1); }

  .synopsis {
    font-size: 1rem;
    color: var(--text-dim);
    line-height: 1.7;
    margin-bottom: 1.5rem;
    font-style: italic;
  }

  /* Ratings section */
  .section-label {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .rating-list { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem; }

  .rating-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.85rem 1rem;
  }

  .rating-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.4rem;
  }

  .reader-name {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text);
  }

  .rating-date {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.6rem;
    color: var(--text-muted);
  }

  .rating-blurb {
    font-size: 0.95rem;
    color: var(--text-dim);
    font-style: italic;
  }

  /* Add rating form */
  .add-rating-form {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
  }

  .form-row { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem; }

  input[type=text], textarea {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.55rem 0.85rem;
    font-family: 'Crimson Pro', serif;
    font-size: 1rem;
    border-radius: var(--radius);
    outline: none;
    width: 100%;
    transition: border-color 0.2s;
  }

  input[type=text]:focus, textarea:focus { border-color: var(--accent); }

  textarea { resize: vertical; min-height: 70px; }

  .star-picker {
    display: flex;
    gap: 4px;
    margin-bottom: 0.75rem;
  }

  .star-picker .sp {
    font-size: 1.6rem;
    cursor: pointer;
    color: var(--star-off);
    transition: color 0.1s, transform 0.1s;
    line-height: 1;
  }

  .star-picker .sp:hover,
  .star-picker .sp.active { color: var(--star-on); transform: scale(1.15); }

  /* Add Book Modal */
  .add-book-form { padding: 2rem; }

  .add-book-form h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: var(--text);
  }

  .form-group { margin-bottom: 1rem; }

  .form-group label {
    display: block;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.35rem;
  }

  .lookup-row {
    display: flex;
    gap: 0.5rem;
  }

  .lookup-row input { flex: 1; }

  .lookup-preview {
    display: none;
    gap: 1.5rem;
    padding: 1rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin: 1rem 0;
    align-items: flex-start;
  }

  .lookup-preview.visible { display: flex; }

  .lookup-preview img {
    width: 80px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .lookup-preview-info { flex: 1; }

  .lookup-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; margin-bottom: 0.2rem; }
  .lookup-author { font-family: 'Josefin Sans', sans-serif; font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem; }

  .tag-editor {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    padding: 0.5rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    min-height: 42px;
    cursor: text;
  }

  .tag-editor .te-tag {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.62rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .te-remove {
    cursor: pointer;
    color: var(--text-muted);
    font-size: 0.8rem;
    line-height: 1;
    transition: color 0.15s;
  }

  .te-remove:hover { color: var(--accent); }

  .te-input {
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'Crimson Pro', serif;
    font-size: 0.9rem;
    min-width: 80px;
    flex: 1;
    padding: 0.1rem 0;
  }

  .spinner {
    display: inline-block;
    width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-left: 0.5rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state {
    text-align: center;
    padding: 6rem 2rem;
    color: var(--text-muted);
  }

  .empty-state .icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.4; }

  .empty-state p {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.75rem 1.5rem;
    border-radius: 40px;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    z-index: 9999;
    transition: transform 0.3s;
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--accent); }
  .toast.error { border-color: #c0392b; color: #e74c3c; }

  .delete-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.75rem;
    padding: 0.2rem;
    transition: color 0.15s;
    margin-left: 0.5rem;
  }

  .delete-btn:hover { color: var(--accent); }

  .book-card-actions {
    display: flex;
    gap: 0.5rem;
    padding: 0 0.85rem 0.85rem;
  }

  .action-btn {
    flex: 1;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.58rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.4rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.15s;
  }

  .action-btn:hover { border-color: var(--accent); color: var(--accent); }

  .stats-bar {
    display: flex;
    gap: 2rem;
    padding: 0.6rem 2rem;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.62rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }

  .stat-val { color: var(--text-dim); }

  @media (max-width: 700px) {
    .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; padding: 1rem; }
    .toolbar { padding: 0.75rem 1rem; }
    .book-detail { grid-template-columns: 1fr; }
    .book-detail-cover img, .book-detail-cover .cover-ph { min-height: 200px; max-height: 300px; border-radius: 8px 8px 0 0; }
  }
</style>
</head>
<body>

<header>
  <div class="site-title">The Family <span>Shelf</span></div>
  <div class="site-subtitle">Our shared library &amp; reading log</div>
</header>

<div class="toolbar">
  <div class="search-wrap">
    <input type="text" id="searchInput" placeholder="Search titles or authors‚Ä¶">
  </div>
  <select id="genreSelect"><option value="">All genres</option></select>
  <select id="triggerSelect"><option value="">All content</option></select>
  <select id="sortSelect">
    <option value="recent">Recently added</option>
    <option value="rating">Top rated</option>
    <option value="title">A ‚Äì Z</option>
  </select>
  <button class="btn btn-primary" onclick="openAddModal()">+ Add Book</button>
</div>

<div class="filter-tags" id="filterTags"></div>

<div class="stats-bar" id="statsBar">
  <span>üìö <span class="stat-val" id="statBooks">0</span> books</span>
  <span>‚≠ê <span class="stat-val" id="statRatings">0</span> ratings</span>
</div>

<div class="grid" id="booksGrid"></div>

<!-- Book Detail Modal -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('detailModal')">‚úï</button>
    <div id="detailContent"></div>
  </div>
</div>

<!-- Add Book Modal -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addModal')">‚úï</button>
    <div class="add-book-form">
      <h2>Add a Book</h2>

      <div class="form-group">
        <label>Title</label>
        <div class="lookup-row">
          <input type="text" id="addTitle" placeholder="Enter book title‚Ä¶">
          <button class="btn btn-ghost" onclick="lookupBook()" id="lookupBtn">Look Up</button>
        </div>
      </div>

      <div class="form-group">
        <label>Author</label>
        <input type="text" id="addAuthor" placeholder="Author name‚Ä¶">
      </div>

      <div class="lookup-preview" id="lookupPreview">
        <img id="previewCover" src="" alt="cover">
        <div class="lookup-preview-info">
          <div class="lookup-title" id="previewTitle"></div>
          <div class="lookup-author" id="previewAuthor"></div>
          <div id="previewGenres" style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.5rem;"></div>
        </div>
      </div>

      <div class="form-group">
        <label>Cover Image URL <span style="opacity:0.5">(auto-filled)</span></label>
        <input type="text" id="addCover" placeholder="https://‚Ä¶">
      </div>

      <div class="form-group">
        <label>Synopsis <span style="opacity:0.5">(auto-filled)</span></label>
        <textarea id="addSynopsis" rows="4" placeholder="Book description‚Ä¶"></textarea>
      </div>

      <div class="form-group">
        <label>Genres <span style="opacity:0.5">‚Äî press Enter to add</span></label>
        <div class="tag-editor" id="genreEditor" onclick="this.querySelector('.te-input').focus()">
          <input class="te-input" id="genreInput" placeholder="e.g. Dark Romance" onkeydown="tagKeydown(event,'genres')">
        </div>
      </div>

      <div class="form-group">
        <label>Trigger Warnings <span style="opacity:0.5">‚Äî press Enter to add</span></label>
        <div class="tag-editor" id="triggerEditor" onclick="this.querySelector('.te-input').focus()">
          <input class="te-input" id="triggerInput" placeholder="e.g. Dubcon" onkeydown="tagKeydown(event,'triggers')">
        </div>
      </div>

      <div style="display:flex;gap:0.75rem;margin-top:1.5rem;">
        <button class="btn btn-primary" onclick="submitBook()" id="submitBookBtn">Add to Library</button>
        <button class="btn btn-ghost" onclick="closeModal('addModal')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';  // same origin

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let books = [];
let filters = { genre: '', trigger: '', search: '', sort: 'recent' };
let pendingGenres = [];
let pendingTriggers = [];
let lookupData = null;
let currentBookId = null;
let ratingStars = 0;

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  await Promise.all([loadBooks(), loadFilters()]);
  document.getElementById('searchInput').addEventListener('input', debounce(e => {
    filters.search = e.target.value;
    loadBooks();
  }, 300));
  document.getElementById('genreSelect').addEventListener('change', e => {
    filters.genre = e.target.value;
    loadBooks();
    syncFilterTags();
  });
  document.getElementById('triggerSelect').addEventListener('change', e => {
    filters.trigger = e.target.value;
    loadBooks();
    syncFilterTags();
  });
  document.getElementById('sortSelect').addEventListener('change', e => {
    filters.sort = e.target.value;
    loadBooks();
  });
}

function debounce(fn, ms) {
  let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
}

// ‚îÄ‚îÄ Books ‚îÄ‚îÄ
async function loadBooks() {
  const params = new URLSearchParams();
  if (filters.genre) params.set('genre', filters.genre);
  if (filters.trigger) params.set('trigger', filters.trigger);
  if (filters.search) params.set('search', filters.search);
  if (filters.sort) params.set('sort', filters.sort);

  const res = await fetch(`${API}/api/books?${params}`);
  books = await res.json();
  renderGrid();
  updateStats();
}

async function loadFilters() {
  const res = await fetch(`${API}/api/filters`);
  const data = await res.json();

  const gs = document.getElementById('genreSelect');
  gs.innerHTML = '<option value="">All genres</option>' +
    data.genres.map(g => `<option value="${esc(g)}">${esc(g)}</option>`).join('');

  const ts = document.getElementById('triggerSelect');
  ts.innerHTML = '<option value="">All content</option>' +
    data.triggers.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');

  renderFilterTags(data.genres, data.triggers);
}

function renderFilterTags(genres, triggers) {
  const el = document.getElementById('filterTags');
  const html = [
    ...genres.map(g => `<span class="tag${filters.genre===g?' active':''}" onclick="setFilter('genre','${esc(g)}')">${esc(g)}</span>`),
    ...triggers.map(t => `<span class="tag trigger${filters.trigger===t?' active':''}" onclick="setFilter('trigger','${esc(t)}')" title="Trigger warning">‚ö† ${esc(t)}</span>`)
  ].join('');
  el.innerHTML = html || '<span style="font-family:Josefin Sans,sans-serif;font-size:0.6rem;letter-spacing:0.1em;color:var(--text-muted);text-transform:uppercase">No filters yet ‚Äî genres appear as books are added</span>';
}

function syncFilterTags() {
  const tags = document.querySelectorAll('.tag');
  tags.forEach(t => {
    const isGenre = !t.classList.contains('trigger');
    const val = t.textContent.replace('‚ö† ','').trim();
    if (isGenre) t.classList.toggle('active', filters.genre === val);
    else t.classList.toggle('active', filters.trigger === val);
  });
}

function setFilter(type, val) {
  if (filters[type] === val) filters[type] = '';
  else filters[type] = val;

  if (type === 'genre') document.getElementById('genreSelect').value = filters.genre;
  if (type === 'trigger') document.getElementById('triggerSelect').value = filters.trigger;

  syncFilterTags();
  loadBooks();
}

function updateStats() {
  document.getElementById('statBooks').textContent = books.length;
  const totalRatings = books.reduce((s,b) => s + (b.rating_count || 0), 0);
  document.getElementById('statRatings').textContent = totalRatings;
}

function renderGrid() {
  const grid = document.getElementById('booksGrid');
  if (!books.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <div class="icon">üìñ</div>
      <p>No books found ‚Äî add one to start the shelf</p>
    </div>`;
    return;
  }

  grid.innerHTML = books.map(b => {
    const avgStars = renderStarsHTML(b.avg_rating || 0, 'stars-display');
    const genres = (b.genres || []).slice(0,3).map(g =>
      `<span class="genre-chip${['Dark Romance','Romance'].includes(g)?' highlight':''}">${esc(g)}</span>`
    ).join('');

    const cover = b.cover_url
      ? `<img class="book-cover" src="${esc(b.cover_url)}" alt="${esc(b.title)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
      : '';
    const ph = `<div class="book-cover-placeholder" style="${b.cover_url?'display:none':''}">üìö</div>`;

    return `<div class="book-card" onclick="openDetail(${b.id})">
      ${cover}${ph}
      <div class="card-body">
        <div class="card-title">${esc(b.title)}</div>
        <div class="card-author">${esc(b.author)}</div>
        <div class="card-rating">
          ${avgStars}
          <span class="rating-count">${b.rating_count ? b.rating_count + ' rating' + (b.rating_count>1?'s':'') : 'No ratings yet'}</span>
        </div>
        <div class="card-genres">${genres}</div>
      </div>
      <div class="book-card-actions">
        <button class="action-btn" onclick="event.stopPropagation();openRating(${b.id})">Rate</button>
        <button class="action-btn" onclick="event.stopPropagation();deleteBook(${b.id}, '${esc(b.title)}')">Remove</button>
      </div>
    </div>`;
  }).join('');
}

function renderStarsHTML(avg, cls) {
  return `<div class="${cls}">${[1,2,3,4,5].map(i =>
    `<span class="s${i <= Math.round(avg) ? ' on' : ''}">‚òÖ</span>`
  ).join('')}</div>`;
}

// ‚îÄ‚îÄ Book Detail ‚îÄ‚îÄ
async function openDetail(id) {
  currentBookId = id;
  const res = await fetch(`${API}/api/books/${id}`);
  const book = await res.json();
  renderDetail(book);
  openModal('detailModal');
}

function renderDetail(book) {
  const ratings = book.ratings || [];
  const avgRating = ratings.length ? ratings.reduce((s,r) => s+r.stars, 0) / ratings.length : 0;

  const coverHtml = book.cover_url
    ? `<img src="${esc(book.cover_url)}" alt="${esc(book.title)}">`
    : `<div class="cover-ph">üìö</div>`;

  const genres = (book.genres || []).map(g =>
    `<span class="meta-pill">${esc(g)}</span>`).join('');

  const triggers = (book.trigger_warnings || []).map(t =>
    `<span class="meta-pill tw">‚ö† ${esc(t)}</span>`).join('');

  const ratingsList = ratings.length
    ? ratings.map(r => `
      <div class="rating-item">
        <div class="rating-header">
          <div style="display:flex;align-items:center;gap:0.5rem">
            <span class="reader-name">${esc(r.reader_name)}</span>
            ${renderStarsHTML(r.stars,'stars-display')}
          </div>
          <div style="display:flex;align-items:center">
            <span class="rating-date">${new Date(r.rated_at).toLocaleDateString()}</span>
            <button class="delete-btn" onclick="deleteRating(${r.id})" title="Remove rating">‚úï</button>
          </div>
        </div>
        ${r.blurb ? `<div class="rating-blurb">"${esc(r.blurb)}"</div>` : ''}
      </div>`).join('')
    : '<p style="color:var(--text-muted);font-style:italic;font-size:0.9rem">No ratings yet ‚Äî be the first!</p>';

  const meta = [];
  if (book.published_year) meta.push(`<span class="meta-pill">${book.published_year}</span>`);
  if (book.page_count) meta.push(`<span class="meta-pill">${book.page_count} pages</span>`);

  document.getElementById('detailContent').innerHTML = `
    <div class="book-detail">
      <div class="book-detail-cover">${coverHtml}</div>
      <div class="book-detail-info">
        <div class="detail-title">${esc(book.title)}</div>
        <div class="detail-author">by ${esc(book.author)}</div>

        ${meta.length ? `<div class="detail-meta">${meta.join('')}</div>` : ''}

        ${ratings.length ? `<div class="avg-rating-display">
          ${renderStarsHTML(avgRating,'avg-stars-big')}
          <div>
            <div class="avg-num">${avgRating.toFixed(1)}</div>
            <div class="avg-label">${ratings.length} rating${ratings.length>1?'s':''}</div>
          </div>
        </div>` : ''}

        ${book.kindle_url ? `<a class="kindle-link" href="${esc(book.kindle_url)}" target="_blank" rel="noopener">
          üì± Find on Kindle Unlimited
        </a>` : ''}

        ${genres || triggers ? `<div class="detail-meta">${genres}${triggers}</div>` : ''}

        ${book.synopsis ? `<div class="synopsis">${esc(book.synopsis).substring(0, 600)}${book.synopsis.length > 600 ? '‚Ä¶' : ''}</div>` : ''}

        <div class="section-label">Ratings</div>
        <div class="rating-list">${ratingsList}</div>

        <div class="section-label">Add Your Rating</div>
        <div class="add-rating-form">
          <div class="form-row">
            <input type="text" id="raterName" placeholder="Your name‚Ä¶" style="flex:1">
          </div>
          <div class="star-picker" id="starPicker">
            ${[1,2,3,4,5].map(i => `<span class="sp" data-val="${i}" onclick="setStar(${i})">‚òÖ</span>`).join('')}
          </div>
          <div class="form-row">
            <textarea id="raterBlurb" placeholder="What did you think? (optional)‚Ä¶"></textarea>
          </div>
          <button class="btn btn-primary" onclick="submitRating(${book.id})">Save Rating</button>
        </div>
      </div>
    </div>`;

  ratingStars = 0;
}

function setStar(n) {
  ratingStars = n;
  document.querySelectorAll('.star-picker .sp').forEach((s, i) => {
    s.classList.toggle('active', i < n);
  });
}

async function submitRating(bookId) {
  const name = document.getElementById('raterName').value.trim();
  if (!name) return toast('Please enter your name', 'error');
  if (!ratingStars) return toast('Please pick a star rating', 'error');

  const blurb = document.getElementById('raterBlurb').value.trim();

  const res = await fetch(`${API}/api/books/${bookId}/ratings`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reader_name: name, stars: ratingStars, blurb })
  });

  if (res.ok) {
    toast('Rating saved!', 'success');
    openDetail(bookId);
    loadBooks();
  } else {
    toast('Failed to save rating', 'error');
  }
}

async function deleteRating(ratingId) {
  if (!confirm('Remove this rating?')) return;
  await fetch(`${API}/api/ratings/${ratingId}`, { method: 'DELETE' });
  openDetail(currentBookId);
  loadBooks();
}

async function openRating(id) {
  currentBookId = id;
  await openDetail(id);
  setTimeout(() => {
    const form = document.querySelector('.add-rating-form');
    if (form) form.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

// ‚îÄ‚îÄ Add Book ‚îÄ‚îÄ
function openAddModal() {
  // Reset form
  ['addTitle','addAuthor','addCover','addSynopsis'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('lookupPreview').classList.remove('visible');
  pendingGenres = [];
  pendingTriggers = [];
  lookupData = null;
  renderTagEditor('genres');
  renderTagEditor('triggers');
  openModal('addModal');
}

async function lookupBook() {
  const title = document.getElementById('addTitle').value.trim();
  if (!title) return toast('Enter a title first', 'error');

  const author = document.getElementById('addAuthor').value.trim();
  const btn = document.getElementById('lookupBtn');
  btn.innerHTML = 'Looking up <span class="spinner"></span>';
  btn.disabled = true;

  try {
    const res = await fetch(`${API}/api/lookup?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}`);
    lookupData = await res.json();

    document.getElementById('addTitle').value = lookupData.title || title;
    document.getElementById('addAuthor').value = lookupData.author || author;
    document.getElementById('addCover').value = lookupData.cover_url || '';
    document.getElementById('addSynopsis').value = lookupData.synopsis || '';

    pendingGenres = lookupData.genres || [];
    pendingTriggers = lookupData.trigger_warnings || [];
    renderTagEditor('genres');
    renderTagEditor('triggers');

    const preview = document.getElementById('lookupPreview');
    document.getElementById('previewTitle').textContent = lookupData.title;
    document.getElementById('previewAuthor').textContent = lookupData.author;

    const img = document.getElementById('previewCover');
    if (lookupData.cover_url) {
      img.src = lookupData.cover_url;
      img.style.display = 'block';
    } else {
      img.style.display = 'none';
    }

    document.getElementById('previewGenres').innerHTML =
      [...pendingGenres, ...pendingTriggers.map(t => '‚ö† ' + t)]
        .map(g => `<span class="genre-chip">${esc(g)}</span>`).join('');

    preview.classList.add('visible');
    toast('Book found!', 'success');
  } catch(e) {
    toast('Lookup failed ‚Äî fill in details manually', 'error');
  } finally {
    btn.textContent = 'Look Up';
    btn.disabled = false;
  }
}

async function submitBook() {
  const title = document.getElementById('addTitle').value.trim();
  if (!title) return toast('Title is required', 'error');

  const btn = document.getElementById('submitBookBtn');
  btn.innerHTML = 'Adding‚Ä¶ <span class="spinner"></span>';
  btn.disabled = true;

  const body = {
    title,
    author: document.getElementById('addAuthor').value.trim(),
    cover_url: document.getElementById('addCover').value.trim() || null,
    synopsis: document.getElementById('addSynopsis').value.trim(),
    genres: pendingGenres,
    trigger_warnings: pendingTriggers,
    ...(lookupData ? {
      isbn: lookupData.isbn,
      open_library_key: lookupData.open_library_key,
      published_year: lookupData.published_year,
      page_count: lookupData.page_count,
      kindle_url: lookupData.kindle_url,
    } : {})
  };

  try {
    const res = await fetch(`${API}/api/books`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (res.status === 409) {
      toast('This book is already in the library!', 'error');
      return;
    }

    if (!res.ok) throw new Error('Server error');

    const newBook = await res.json();
    closeModal('addModal');
    await loadBooks();
    await loadFilters();
    toast(`"${newBook.title}" added to the shelf!`, 'success');
    setTimeout(() => openDetail(newBook.id), 400);
  } catch(e) {
    toast('Failed to add book: ' + e.message, 'error');
  } finally {
    btn.textContent = 'Add to Library';
    btn.disabled = false;
  }
}

async function deleteBook(id, title) {
  if (!confirm(`Remove "${title}" from the library? All ratings will be lost.`)) return;
  await fetch(`${API}/api/books/${id}`, { method: 'DELETE' });
  await loadBooks();
  await loadFilters();
  toast(`"${title}" removed`, 'success');
}

// ‚îÄ‚îÄ Tag Editor ‚îÄ‚îÄ
function renderTagEditor(type) {
  const arr = type === 'genres' ? pendingGenres : pendingTriggers;
  const editorId = type === 'genres' ? 'genreEditor' : 'triggerEditor';
  const inputId = type === 'genres' ? 'genreInput' : 'triggerInput';
  const editor = document.getElementById(editorId);
  const input = document.getElementById(inputId);

  const tags = arr.map((t, i) => `
    <span class="te-tag">
      ${esc(t)}
      <span class="te-remove" onclick="removeTag('${type}',${i})">‚úï</span>
    </span>`).join('');

  editor.innerHTML = tags + `<input class="te-input" id="${inputId}" placeholder="${type === 'genres' ? 'e.g. Dark Romance' : 'e.g. Dubcon'}" onkeydown="tagKeydown(event,'${type}')">`;
}

function tagKeydown(e, type) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,$/, '');
    if (val) {
      if (type === 'genres') pendingGenres.push(val);
      else pendingTriggers.push(val);
      renderTagEditor(type);
    }
  }
}

function removeTag(type, idx) {
  if (type === 'genres') pendingGenres.splice(idx, 1);
  else pendingTriggers.splice(idx, 1);
  renderTagEditor(type);
}

// ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow = '';
}

document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) closeModal(el.id); });
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => closeModal(m.id));
});

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
let toastTimer;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = 'toast', 3000);
}

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

init();
</script>
</body>
</html>
